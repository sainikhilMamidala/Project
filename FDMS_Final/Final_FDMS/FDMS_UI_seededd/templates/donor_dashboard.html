{% extends 'base.html' %}
{% load tz %}
{% block content %}

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FDMS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    body {
        background: #f5f7fa;
    }

    .page-container {
        padding: 20px;
    }

    .custom-card {
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        border: none;
    }

    .custom-card h5,
    .custom-card h6 {
        font-weight: 600;
    }

    .section-title {
        margin-top: 30px;
        font-weight: 700;
        color: #333;
        border-left: 4px solid #007bff;
        padding-left: 10px;
    }

    .delete-btn {
        background: #e74c3c;
        border: none;
        padding: 6px 14px;
        font-size: 14px;
        border-radius: 6px;
        color: white;
        transition: 0.2s ease;
    }

    .delete-btn:hover {
        background: #c0392b;
    }

    .form-section {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        margin-bottom: 25px;
    }

    .recycle-card {
        background: #f2f2f2;
        border-radius: 10px;
        padding: 15px;
        border-left: 5px solid #888;
    }
</style>

</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container">
    <a class="navbar-brand" href="/">FDMS</a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto">
        {% if user.is_authenticated %}
          <li class="nav-item">
            <form method="post" action="/logout/">
              {% csrf_token %}
              <button class="btn btn-link nav-link">Logout</button>
            </form>
          </li>
        {% else %}
          <li class="nav-item"><a class="nav-link" href="/admin/">Admin</a></li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>


<div class="container page-container">

    <h2 class="section-title">Create Donation</h2>

    <div class="form-section">
        <form method="post">
            {% csrf_token %}

            {% if form.errors %}
                <div class="alert alert-danger">
                    <strong>Please fix the errors below:</strong>
                </div>
            {% endif %}

            <div class="mb-3">
                <label class="form-label">Items:</label>
                {{ form.title }}
            </div>

            <div class="mb-3">
                <label class="form-label">Location:</label>
                {{ form.location }}
            </div>

            <div class="mb-3">
                <label class="form-label">Address:</label>
                {{ form.address }}
            </div>

            <div class="mb-3">
                <label class="form-label">Quantity:</label>
                {{ form.initial_quantity }}
            </div>

            <div class="mb-3">
                <label class="form-label">Expiry date:</label>
                {{ form.expiry_date }}
            </div>

            <div class="mb-3">
                <label class="form-label">Donation type:</label>
                {{ form.donation_type }}
            </div>

            <button class="btn btn-primary" type="submit">Create</button>
        </form>
    </div>


    <h2 class="section-title">My Donations</h2>

{% for d in donations %}
<div class="card custom-card mb-3">
    <div class="card-body">
        <h5 class="card-title">{{ d.title }}</h5>

        <p>
            <strong>Location:</strong> {{ d.location }}<br>
            <strong>Address:</strong> {{ d.address }}<br>
            <strong>Initial Quantity:</strong> {{ d.initial_quantity }}<br>
            <strong>Expiry:</strong> {{ d.expiry_date }}
        </p>

        {% if d.claims.exists %}
        <h6>Claimed by:</h6>
        <ul>
            {% for claim in d.claims.all %}
                <li>{{ claim.claimer.username }} claimed {{ claim.quantity }} on {{ claim.created_at|date:"Y-m-d" }}</li>
            {% endfor %}
        </ul>
        {% else %}
            <strong>Claimed by:</strong> None yet
        {% endif %}

        {% if d.available_quantity > 0 and not d.is_deleted %}

    <a href="{% url 'edit_donation' d.pk %}" class="btn btn-warning btn-sm mb-2">
        Edit
    </a>

    <form method="post" action="{% url 'delete_donation' d.pk %}">
        {% csrf_token %}
        <button class="delete-btn" onclick="return confirm('Delete the remaining quantity of this donation?');">
            Delete Remaining Quantity
        </button>
    </form>

{% elif d.available_quantity < 1 %}
    <strong>Available Quantity:</strong> 0 <br>
    <span class="text-muted">Fully claimed</span>

{% else %}
    <h6>Available Quantity: <span> 0 </span></h6>
{% endif %}

    </div>
</div>
{% empty %}
<p>You have not added any donations yet.</p>
{% endfor %}


<h3 class="section-title">Deleted Donations (Recycle Bin)</h3>

{% if deleted_items %}
  {% for d in deleted_items %}
    <div class="recycle-card mb-3">
      <h6 class="mb-2">
        {{ d.title }}
        <small class="text-muted">
            {% if d.available_quantity > 0 %}(Deleted){% else %}(deleted){% endif %}
        </small>
      </h6>

      <p>
        <strong>Location:</strong> {{ d.location }}<br>
        <strong>Address:</strong> {{ d.address }}<br>
        <strong>Initial Quantity:</strong> {{ d.initial_quantity }}<br>
        <strong>Deleted Quantity:</strong> {{ d.deleted_quantity }}<br>
        <strong>Deleted at:</strong> {{ d.deleted_at }}
      </p>
    </div>
  {% endfor %}
{% else %}
  <p class="text-muted">No deleted donations.</p>
{% endif %}

</div>

</body>
</html>

{% endblock %}
